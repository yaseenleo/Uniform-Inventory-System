<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Vendor Payment</title>

    <link rel="stylesheet" href="../../../css/style.css">
    <link rel="stylesheet" href="../../../css/salesStyle.css">

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <!-- Font Awesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ"
        crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY"
        crossorigin="anonymous"></script>
</head>

<body onload="fill()">

   
    <div class="nav-side-menu">
            <div class="brand brand-color">
                <h5>Abbas Ali & Sons Uniforms and Textiles</h5>
            </div>
            <i class="fa fa-bars fa-2x toggle-btn" data-toggle="collapse" data-target="#menu-content"></i>
            <div class="menu-list" id="menu-content">

                    <ul id="accordion1" class="menu-content collapse out">

                            <li data-toggle="collapse" data-parent="#accordion1" href="#thirdLink"> <a> <i></i> Sales</a>
            
                                <ul id="thirdLink" class="collapse sub-list">
                                    <li>
                                        <a href="/sale/sales_order">Sales Order</a>
                                    </li>
                                    <li>
                                        <a href="/sale/packing_list">Packing List</a>
                                    </li>
                                    <li>
                                        <a href="/sale/commercial_invoice">Commercial Invoice</a>
                                    </li>
                                    <li>
                                        <a href="/sale/reciept_voucher">Reciept Voucher</a>
                                    </li>
                                </ul>
                            </li>
                            <li data-toggle="collapse" data-parent="#accordion1" href="#firstLink"> <a> <i></i> Purchase</a>
            
                                <ul id="firstLink" class="collapse sub-list">
                                    <li>
                                        <a href="/purchase/purchase_order">Purchase Order</a>
                                    </li>
                                    <li>
                                        <a href="/purchase/gr_note">Good Receiving Note / Invoice</a>
                                    </li>
            
                                    <li>
                                        <a href="/purchase/payment_voucher">Vendor Payment</a>
                                    </li>
                                </ul>
            
                            </li>
                            <li>
                                <a href="/production">
                                    <i></i> Production</a>
                            </li>
                            <li data-toggle="collapse" data-parent="#accordion1" href="#reports"> <a> <i></i> Reports</a>
            
                                <ul id="reports" class="collapse sub-list">
                                    <li>
                                        <a href="/reports/sales_report">Sales Report</a>
                                    </li>
                                    <li>
                                        <a href="/reports/purchase_report">Purchases Report</a>
                                    </li>
            
                                    <li>
                                        <a href="/reports/production_report">Productions Report</a>
                                    </li>
                                    <li>
                                        <a href="/reports/accounts_report">Accounts Report</a>
                                    </li>
                                </ul>
            
                            </li>
            
                            <li>
                                <a href="/master">
                                    <i></i> Master Data
                                </a>
                            </li>
            
                            <li>
                                <a href="/master_view">
                                    <i></i> Master View
            
                                </a>
                            </li>
            
                        </ul>
            
    
            </div>
        </div>

    <div id="main" class="wrapper container-fluid">
        <!-- Sidebar  -->

            <div class="container sales-container" id="main_place">

                <div class="container payscript-container">
                    <h1 class="doc-head-text">Vendor Payment</h1>
                    <div class="row">
                            <div class="col-4">
                                    <div class="col-md-4" >
                                            Vendor
                                         </div>
                                         <div class="col-md-8">
                                             <select class="form-control"  id="vendors_select" onchange="fill_pos(this)">
                                                 <option value="">Select Vendor</option>
                                             </select>    
                                         </div>
                            </div>
                            <div class="col-4">
                                    <div class="col-md-4" >
                                            V.P.O Ref
                                         </div>
                                         <div class="col-12">
                                             <select class="form-control"  id="pos_select" onchange="fill_invoices(this)">
                                                 <option value="">Select V.P.O#</option>
                                             </select>    
                                         </div>
                            </div>
                            <div class="col-4" >
                                    <div class="col-md-6" >
                                            Invoice Ref
                                         </div>
                                         <div class="col-md-12">
                                             <select class="form-control"  id="invoices_select" onchange="fill_items(this)">
                                                 <option value="">Select Invoice</option>
                                             </select>    
                                         </div>
                            </div>
                    </div>
                    <br><br>
                    <div class="row">

                        <div class="col-6 pay-receipt-info">
                            <h3>ABBAS ALI & SONS</h3>
                            <p><address id="address"></address></p> <!-- fetch address -->
                            <p><address id="city">karachi,pk</address></p> <!-- fetch city -->
                            <p>Phone: <span id="phone-no">+923452462819,+923452965650</span></p> <!-- fetch phone number -->
                            <p>Tel: <span id="fax-no">+92-31-3-4242673</span></p> <!-- fetch fax number -->
                            <p>Website: <span id="phone-no">www.abbasaliandsons.com</span></p> <!-- fetch website name of company -->


                        </div>
                        <div class="col-6">
                            <div class="row">
                                <div class="col-4">
                                    <p>Payment Mode:</p>
                                </div>
                                <div class="col-8">
                                    <select  class="form-control" id="payment_type" onchange="p_type_set(this)">
                                        <option value="cash">Cash</option>
                                         <option value="cheque">Cheque</option>
                                        <option value="online transfer">Online Transfer</option>
                                    </select>    
                                </div>
                            </div>
                            <div class="row" id="c" style="display:none">   
                                <div class="col-4">
                                        <p>Cheque No:</p>
                                </div>
                                <div class="col-6">
                                        <input type="text" class="form-control" id="c_number">
                                </div>
                            </div>
                            <div class="row" id='o' style="display:none">    
                                    <div class="col-4">
                                            <p>Bank Transaction Number:</p>
                                    </div>
                                    <div class="col-6">
                                            <input type="text" class="form-control" id="t_number">
                                    </div>
                                </div>
                        </div>
                        
                    </div>
                    <script>
                    function p_type_set(e){
                        if(e.value==="cheque")
                        {
                            document.getElementById("c").style.display = "block";
                            document.getElementById("o").style.display = "none";

                        }
                        else if(e.value==="online transfer")
                        {
                            document.getElementById("c").style.display = "none";
                            document.getElementById("o").style.display = "block";

                        }
                        else{
                            document.getElementById("c").style.display = "none";
                            document.getElementById("o").style.display = "none";
                        }
                    }
                    </script>

                </div>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td>Paid:</td>
                            <td>Total Payment Due:</td>
                            <td>Balance:</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="td-cells"><input type="text" class="form-control" id="paying" onkeyup="balance()"></td>
                            <td class="td-cells"><p class="form-control" id="total_payment"></p></td>
                            <td class="td-cells"><p class="form-control" id="balance"></p></td>
                        </tr>
                    </tbody>
                </table>

                <script>
                function balance(){
                    let paying = parseFloat(document.getElementById("paying").value),
                        total = parseFloat(document.getElementById("total_payment").innerHTML),
                        balance = document.getElementById("balance");
                        console.log(paying);
                        console.log(total);
                        balance.innerHTML = (total - paying).toFixed(2);
                        if(paying===null)
                        {
                            balance.innerHTML = (0).toFixed(2);

                        }
                }
                </script>

                <section class="color-1 text-center">
                    <p>
                        <button onclick="generate(this)" class="btn btn-primary">Generate</button>
                    </p>
                </section>

            </div>

           

    </div>

</body>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>

<script src="../../../js/app.js"></script>

<script>
    let vendors,pos,invoices,lpos;  
    function fill(){
        
   
     //// lpos get 
     var xhttp3 = new XMLHttpRequest();
     xhttp3.onreadystatechange = function() {
       if (this.readyState == 4 && this.status == 200) {
        lpos = JSON.parse(this.responseText).lpos;
         str = '<option value="">Select L.P.O</option>';
       // alert(e.innerHTML.length)
           lpos.forEach((lpo)=>{
           str += `<option value="`+lpo.ref+`">`+lpo.ref+`</option>`;
       });
       document.getElementById('lpo_ref').innerHTML = str;
       
        console.log(lpos)
       }
     };
     xhttp3.open("GET", "/get_lpos?flag=purchase_phase", true);
     xhttp3.send(); 
   //// vendors get ///

  var xhttp6 = new XMLHttpRequest();
        xhttp6.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
               vendors = JSON.parse(this.responseText).vendors;
                let c_text = '<option value="">Select Vendor</option>';
                // alert(e.innerHTML.length)
                vendors.forEach((vendor) => {
                    c_text += `<option value='`+vendor.company_name+`'>` + vendor.company_name+ `</option>`;
                });
                document.getElementById('vendors_select').innerHTML = c_text;
                console.log("vendors:",vendors);

            }
        };
        xhttp6.open("GET", "/get_vendors", true);
        xhttp6.send();


  //// vendors get
  //// pos get      ///
  var xhttp5 = new XMLHttpRequest();
        xhttp5.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
               pos = JSON.parse(this.responseText).pos;
               console.log("pos:",pos);

            }
        };
        xhttp5.open("GET", "/get_pos", true);
        xhttp5.send();

  //// pos get      ///

  //// invoices get      ///
  var xhttp3 = new XMLHttpRequest();
        xhttp3.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
               invoices = JSON.parse(this.responseText).invoices;
               console.log("invoices:",invoices);
            }
        };
        xhttp3.open("GET", "/get_gr_notes", true);
        xhttp3.send();

  //// invoices get      ///
 
   
    }
    function fill_pos(e){
        let pos_select = document.getElementById("pos_select");
        let pos_text = '<option value="">Select V.P.O#</option>'
       // alert(e.value);
        pos.forEach((po)=>{
            if(po.vendor===e.value)
            {
                pos_text += `<option value="`+po.po_num+`">`+po.po_num+`</option>`
            }
        });
        pos_select.innerHTML = pos_text;
    }
    function fill_invoices(e){
        let invoices_select = document.getElementById("invoices_select");
        let invoices_text = '<option value="">Select invoice</option>'
       // alert(e.value);
        invoices.forEach((invoice)=>{
            if(invoice.po_ref===e.value)
            {
                invoices_text += `<option value="`+invoice._id+`">`+invoice.invoice_num+`</option>`
            }
        });
        invoices_select.innerHTML = invoices_text;
    }
    function fill_items(e){
      let value = e.value;
     // alert(value);
      let total = document.getElementById("total_payment");
      invoices.forEach((invoice)=>{
          if(invoice._id===value){
              total.innerHTML = invoice.payment;
          }
      })   
      
    }
   function set_vendor(val){
       let value = val;
       if(value.length > 0 ){
           var xhttp = new XMLHttpRequest();
     xhttp.onreadystatechange = function() {
       if (this.readyState == 4 && this.status == 200) {
           console.log(this.responseText);
         vendor = JSON.parse(this.responseText).vendor;
         document.getElementById('buyer-organization-name').value = vendor.company_name;
         document.getElementById('buyer-address').value = vendor.street + "," + vendor.city;
         document.getElementById('buyer-number').value = vendor.phone
       }
     };
     xhttp.open("GET", "/get_vendor?lpo="+val, true);
     xhttp.send();
       }
       else{
           alert("null")
           document.getElementById('buyer-organization-name').value = '';
         document.getElementById('buyer-address').value = '';
         document.getElementById('buyer-number').value = '';
       }
       
   
   }
   function set_list(val){
       let table= document.getElementById('container');
   lpos.forEach((lpo)=>{
       if(lpo.ref===val){
           str=``;
           let items = JSON.parse(lpo.purchase_array);
           items.forEach((item)=>{
               str += `<tr class="d-flex">
                            <td class="col-2 td-cells">
                                `+item.item+`
                            </td>
                            <td class="col-4 td-cells">
                                `+item.description+`
                            </td>
                            <td class="col-2 td-cells">
                                `+item.quantity+`
                            </td>
                            <td class="col-2 td-cells">
                                `+item.price+`
                            </td>
                            <td class="col-2 td-cells">
                                `+((item.quantity)*(item.price))+`
                            </td>
                        </tr>`;               
           });
           table.innerHTML = str;
   
       }
   })
   }
   function generate(e){
   // e.disabled = true;
   let invoice_id = document.getElementById("invoices_select").value;
   let p_type = document.getElementById("payment_type").value;
   let c_number = document.getElementById("c_number").value;
   let t_number = document.getElementById("t_number").value;
   let paying = document.getElementById("paying").value;
   let total = document.getElementById("total_payment").innerHTML;
   let balance = document.getElementById("balance").innerHTML;
   console.log(invoice_id);
   console.log(p_type);
   console.log(c_number);
   console.log(t_number);
   console.log(paying);
   console.log(total);
   console.log(balance);
  

   var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                alert("Payment Voucher is Generated");
                    e.disabled = false;
                   
                    var link = document.createElement("a");
                    link.download = 'payment voucher.xlsx';
                     link.href = '/payment_voucher_report';
                     link.click();
                     document.location.reload();

            }
        };
        xhttp.open("POST", "/payment_voucher", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send("invoice_id="+invoice_id+"&p_type="+p_type+"&c_number="+c_number+
   "&t_number="+t_number+"&paying="+paying+"&total="+total+"&balance="+balance);

   }
   </script>

</html>
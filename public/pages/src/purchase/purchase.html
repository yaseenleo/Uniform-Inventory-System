<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Purchase Order</title>

    <link rel="stylesheet" href="../../../css/style.css">
    <link rel="stylesheet" href="../../../css/salesStyle.css">

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
        crossorigin="anonymous">

</head>

<body onload="fill()">

     <div class="nav-side-menu">
        <div class="brand brand-color">
            <h4>Uniform Inventory</h4>
        </div>
        <i class="fa fa-bars fa-2x toggle-btn" data-toggle="collapse" data-target="#menu-content"></i>
        <div class="menu-list" id="menu-content">

                <ul id="accordion1" class="menu-content collapse out">

                        <li data-toggle="collapse" data-parent="#accordion1" href="#thirdLink"> <a> <i></i> Sales</a>
        
                            <ul id="thirdLink" class="collapse sub-list">
                                <li>
                                    <a href="/sale/sales_order">Sales Order</a>
                                </li>
                                <li>
                                    <a href="/sale/packing_list">Packing List</a>
                                </li>
                                <li>
                                    <a href="/sale/commercial_invoice">Commercial Invoice</a>
                                </li>
                                <li>
                                    <a href="/sale/reciept_voucher">Reciept Voucher</a>
                                </li>
                            </ul>
                        </li>
                        <li data-toggle="collapse" data-parent="#accordion1" href="#firstLink"> <a> <i></i> Purchase</a>
        
                            <ul id="firstLink" class="collapse sub-list">
                                <li>
                                    <a href="/purchase/purchase_order">Purchase Order</a>
                                </li>
                                <li>
                                    <a href="/purchase/gr_note">Good Receiving Note / Invoice</a>
                                </li>
        
                                <li>
                                    <a href="/purchase/payment_voucher">Vendor Payment</a>
                                </li>
                            </ul>
        
                        </li>
                        <li>
                            <a href="/production">
                                <i></i> Production</a>
                        </li>
                        <li data-toggle="collapse" data-parent="#accordion1" href="#reports"> <a> <i></i> Reports</a>
        
                            <ul id="reports" class="collapse sub-list">
                                <li>
                                    <a href="/reports/sales_report">Sales Report</a>
                                </li>
                                <li>
                                    <a href="/reports/purchase_report">Purchases Report</a>
                                </li>
        
                                <li>
                                    <a href="/reports/production_report">Productions Report</a>
                                </li>
                                <li>
                                    <a href="/reports/accounts_report">Accounts Report</a>
                                </li>
                            </ul>
        
                        </li>
        
                        <li>
                            <a href="/master">
                                <i></i> Master Control
                            </a>
                        </li>
        
                        <li>
                            <a href="/master_view">
                                <i></i> Master View
        
                            </a>
                        </li>
        
                        <!-- <li>
                                <a href="/attendance">
                                    <i></i> Attendance
                                </a>
                            </li> -->
        
                    </ul>
        

        </div>
    </div>
    <div id="main" class="container-fluid">

        <div class="container sales-container" id="main_place">

            <div class="row">
                <div class="col-12">
                    <img src="../../../assets/img/aa-logo.jpg" class="rounded float-right md-logo" alt="logo">
                </div>
            </div>

            <div class="packing-slip-header">

                <div class="row">

                    <div class="col-6">
                        <h3>ABBAS ALI & SONS</h3>
                        <p><address id="address"></address></p> <!-- fetch address -->
                        <p><address id="city">karachi,pk</address></p> <!-- fetch city -->
                        <p>Phone: <span id="phone-no">+923452462819,+923452965650</span></p>
                        <!-- fetch phone number -->
                        <p>Tel: <span id="fax-no">+92-31-3-4242673</span></p> <!-- fetch fax number -->
                        <p>Website: <span id="phone-no">www.abbasaliandsons.com</span></p>
                        <!-- fetch website name of company -->

                    </div>

                    <div class="col-6">
                        <h3>PURCHASE ORDER</h3>
                        <div class="row">
                            <div class="col-4">
                                <p>Date:</p>
                            </div>
                            <div class="col-8">
                                <input type="date" class="form-control" id="pur-date">
                            </div>
                        </div>
                        <br>
                        <div class="row">
                                <div class="col-4">
                                    <p>Payment Due Date:</p>
                                </div>
                                <div class="col-8">
                                    <input type="date" class="form-control" id="payment_date">
                                </div>
                        </div>

                       
                        <div class="row">
                            <div class="col-4">
                                V.P.O #
                            </div>
                            <div class="col-8">
                                <p class="form-control" id="pur-po">
                                </p>   
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                C.P.O Ref
                            </div>
                            <div class="col-8">
                                <select class="form-control" id="lpo_ref">
                                    <option>Select C.P.O</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- packing address section -->
            <div class="supply-content">
                <div class="row">
                    <div class="col-6">
                        <h3 class="main-subject">VENDOR:</h3>

                        <div class="row">
                            <div class="col-4">
                                <p>Company Name:</p>
                            </div>
                            <div class="col-8">
                                <select name="vender-info" id="pur-company-name" class="form-control" onchange="fill_vendor()">
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                <p>Name:</p>
                            </div>
                            <div class="col-8">
                                <input type="text" name="vender-info" id="pur-name" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                <p>Street Address</p>
                            </div>
                            <div class="col-8">
                                <input type="text" name="vender-info" id="pur-vender-address" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                <p>City or ZIP:</p>
                            </div>
                            <div class="col-8">
                                <input type="text" name="vender-info" id="pur-vender-city" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                <p>Phone:</p>
                            </div>
                            <div class="col-8">
                                <input type="text" name="vender-info" id="pur-vender-phone" class="form-control">
                            </div>
                        </div>

                    </div>

                    <div class="col-6">
                        <h3 class="main-subject">Ship To:</h3>
                        <div class="row">
                            <div class="col-4">
                                <p>Name:</p>
                            </div>
                            <div class="col-8">
                                <input type="text"  id="pur-ship-name" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                <p>Street Address</p>
                            </div>
                            <div class="col-8">
                                <input type="text"  id="pur-ship-address" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                <p>City or ZIP:</p>
                            </div>
                            <div class="col-8">
                                <input type="text" name="ship-info" id="pur-ship-city" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-4">
                                <p>Phone:</p>
                            </div>
                            <div class="col-8">
                                <input type="text" name="ship-info" id="pur-ship-phone" class="form-control">
                            </div>
                        </div>

                    </div>

                </div>
            </div>

        

            <table class="table table-bordered">
                <thead>
                    <tr class="d-flex">
                        <td class="col-3">Item #</td>
                        <td class="col-5">Description</td>
                        <td class="col-2">Quantity</td>
                        <td class="col-2">Unit Price</td>
                    </tr>
                </thead>
                <tbody id="container">
                    <tr class="d-flex">
                        <td class="col-3 td-cells">
                            <select class="form-control" id="pro1category" onclick="load_items(this)" onchange="set_item(this)">
                            </select>
                        </td>
                        <td class="col-5 td-cells">
                            <input type="text" class="form-control" id="pro1description">
                        </td>
                        <td class="col-2 td-cells">
                            <input type="text" class="form-control" id="pro1quantityavailable" style="display: inline;width: 50%;float: left;">
                            <span></span>
                        </td>
                        <td class="col-2 td-cells">
                            <input type="text" class="form-control" id="pro1unitprice" onkeypress="add_new(event)">
                        </td>
                    </tr>
                </tbody>
            </table>

            <section class="color-1 text-center">
                <p> <a class='btn btn-primary' data-toggle="modal" data-target="#myModal">Terms and Condition</a>
                    <button onclick="generate_purchase_order(this)" class="btn btn-primary" id='proceed_btn' disabled>Generate</button>
                </p>
            </section>

        </div>

        <div class="forms" style="max-width: none; display: none;" id="operation1">

            <div>

                <div class="row">
                    <div class="col-12">
                        <img src="../../../assets/img/optimized-logo.png" class="rounded float-right md-logo" alt="logo">
                    </div>
                </div>

                <div class="packing-slip-header">

                    <div class="row">

                        <div class="col-6">
                            <h3>Company Name</h3>
                            <p><address id="address">Street Address</address></p> <!-- fetch address -->
                            <p><address id="city">City</address></p> <!-- fetch city -->
                            <p>Phone: <span id="phone-no"></span></p> <!-- fetch phone number -->
                            <p>Fax: <span id="fax-no"></span></p> <!-- fetch fax number -->
                            <p>Website: <span id="phone-no"></span></p> <!-- fetch website name of company -->

                        </div>

                        <div class="col-6">
                            <h3>PURCHASE ORDER</h3>
                            <div class="row">
                                <div class="col-4">
                                    <p>Date:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-date-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    P.O #
                                </div>
                                <div class="col-8">
                                    <p id="pur-po-g"></p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- packing address section -->
                <div class="supply-content">
                    <div class="row">
                        <div class="col-6">
                            <h3 class="main-subject">VENDOR:</h3>
                            <div class="row">
                                <div class="col-4">
                                    <p>Name:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-name-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>Company Name:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-company-name-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>Street Address</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-vender-address-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>City or ZIP:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-vender-city-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>Phone:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-vender-phone-g"></p>
                                </div>
                            </div>

                        </div>

                        <div class="col-6">
                            <h3 class="main-subject">Ship To:</h3>
                            <div class="row">
                                <div class="col-4">
                                    <p>Name:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-ship-name"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>Company Name:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-ship-company-name-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>Street Address</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-vender-address-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>City or ZIP:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-ship-vender-city-g"></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <p>Phone:</p>
                                </div>
                                <div class="col-8">
                                    <p id="pur-ship-vender-phone-g"></p>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <div class="purchase-supply supply-info">
                    <table class="table table-sm table-bordered ">
                        <thead>
                            <tr>
                                <th class="head-text-sec">REQUISITIONER</th>
                                <th class="head-text-sec">SHIP VIA</th>
                                <th class="head-text-sec">F.O.B</th>
                                <th class="head-text-sec">SHIPPING TERMS</th>
                            </tr>

                        <tbody>
                            <tr>
                                <td class="td-cells" id="pur-requs-g"></td>
                                <td class="td-cells" id="pur-ship-via-g"></td>
                                <td class="td-cells" id="pur-fob-g"></td>
                                <td class="td-cells" id="pur-ship-term-g"></td>
                            </tr>
                        </tbody>
                        </thead>
                    </table>
                </div>


            </div>

            <!-- product list section -->
            <table class="table table-bordered">
                <thead>
                    <tr class="d-flex">
                        <td class="col-1">S.no</td>
                        <td class="col-1">Item #</td>
                        <td class="col-4">Description</td>
                        <!-- <td class="col-2">Qty Avail</td> -->
                        <td scope="col-2">Qty Order</td>
                        <td class="col-2">Unit Price</td>
                        <td class="col-2">Total Price</td>
                    </tr>

                <tbody id="create-lists">
                    <!-- <tr>
                        <td scope="row">1</td>
                        <td class="category"></td>
                        <td class="description"></td>
                        <td class="qtyavailable"></td>
                        <td class="qtyorder"></td>
                        <td class="unitprice"></td>
                        <td class="totalprice"></td>
                    </tr>

                    <tr>
                        <td scope="row">2</td>
                        <td id="na"></td>
                        <td id="ma"></td>
                        <td id="oa"></td>
                        <td id="pa"></td>
                        <td id="qa"></td>
                        <td id="ra"></td>
                    </tr>

                    <tr>
                        <td scope="row">3</td>
                        <td class="category"></td>
                        <td class="description"></td>
                        <td class="qtyavailable"></td>
                        <td class="qtyorder"></td>
                        <td class="unitprice"></td>
                        <td class="totalprice"></td>
                    </tr> -->
                    <!-- <tr> 
                        <td colspan="6">Total</td>
                        <td colspan="1" id="grandtotal"></td>
                    </tr> -->

                </tbody>
                </thead>
            </table>

        </div>
        

    </div>
     <!-- The Modal -->
     <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Terms and Conditions</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <p id="purchase_terms">Loading...</p>
                   
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="activate_btn()" data-dismiss="modal">Accept Terms & Conditions</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

    <!---  modal-->

</body>
<script>
    function activate_btn() {
        document.getElementById('proceed_btn').disabled = false;
    }
</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>

<script src="../../../js/app.js"></script>

<script>
    let vendors, lpos, raw_items;
    function fill() {
        let select = document.getElementById('pur-company-name');
        let select_item = document.getElementById('pro1category');
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let str = '<option value="null">Select Company</option>';
                vendors = JSON.parse(this.responseText).vendors;
                vendors.forEach(vendor => {
                    str += `<option value='` + vendor.company_name + `'>` + vendor.company_name + `</option>`
                });
                select.innerHTML = str;
                console.log(vendors);
            }
        };
        xhttp.open("GET", "/get_vendors", true);
        xhttp.send();
        // get raw_items
        var xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                str = '<option value="null">Select Raw Item</option>';
                raw_items = JSON.parse(this.responseText).raw_items;
                raw_items.forEach(raw_item => {
                    str += `<option value='` + raw_item.name + `'>` + raw_item.name + `</option>`
                });
                select_item.innerHTML = str;
                console.log(raw_items);
            }
        };
        xhttp2.open("GET", "/get_raw_items", true);
        xhttp2.send();
        /// get raw_items
        //// lpos get 
        var xhttp3 = new XMLHttpRequest();
        xhttp3.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                lpos = JSON.parse(this.responseText).lpos;
                str = '<option>Select C.P.O</option>';
                // alert(e.innerHTML.length)
                lpos.forEach((lpo) => {
                    str += `<option>` + lpo.ref + `</option>`;
                });
                document.getElementById('lpo_ref').innerHTML = str;

                console.log(lpos)
            }
        };
        xhttp3.open("GET", "/get_lpos?flag=order_phase", true);
        xhttp3.send();

        //// lpos get
        var xhttp4 = new XMLHttpRequest();
        xhttp4.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById('pur-po').innerHTML = new Date().getFullYear() + "/" + JSON.parse(this.responseText).info[0].po_num;
               document.getElementById("purchase_terms").innerHTML = JSON.parse(this.responseText).info[0].purchase_terms;
            }
        };
        xhttp4.open("GET", "/get_info", true);
        xhttp4.send();

    }
    function fill_vendor() {
        let name = document.getElementById('pur-company-name').value;
        if (name === "null") {
            document.getElementById('pur-name').value = '';
            document.getElementById('pur-vender-address').value = '';
            document.getElementById('pur-vender-city').value = '';
            document.getElementById('pur-vender-phone').value = '';
            document.getElementById('pur-ship-name').value = '';
            document.getElementById('pur-ship-address').value = '';
            document.getElementById('pur-ship-city').value = '';
            document.getElementById('pur-ship-phone').value = '';
        }
        else {
            vendors.forEach((vendor) => {
                if (name === vendor.company_name) {
                    document.getElementById('pur-name').value = vendor.name;
                    document.getElementById('pur-vender-address').value = vendor.street;
                    document.getElementById('pur-vender-city').value = vendor.city;
                    document.getElementById('pur-vender-phone').value = vendor.phone;
                    document.getElementById('pur-ship-name').value = vendor.name;
                    document.getElementById('pur-ship-address').value = vendor.street;
                    document.getElementById('pur-ship-city').value = vendor.city;
                    document.getElementById('pur-ship-phone').value = vendor.phone;

                }

            })
        }

    }
    function load_lpos(e) {
        let str = '';
        // alert(e.innerHTML.length)
        if (e.innerHTML.length < 10) {
            lpos.forEach((lpo) => {
                str += `<option>` + lpo.ref + `</option>`;
            });
            e.innerHTML = str;
        }
        console.log("str:" + str);




    }
    function set_item(e) {
        // alert(e.value);
        let value = e.value;
        let detail = e.parentNode.parentNode.getElementsByTagName('td')[1].getElementsByTagName('input')[0];
        let price = e.parentNode.parentNode.getElementsByTagName('td')[3].getElementsByTagName('input')[0];
        let unit = e.parentNode.parentNode.getElementsByTagName('td')[2].getElementsByTagName("span")[0];

        raw_items.forEach((item) => {
            if (item.name === value) {
                detail.value = item.detail;
                price.value = item.price;
                unit.innerHTML = item.unit;
            }
        })
    }
    function load_items(e) {
        let str = '<option value="null">Select raw item</option>';
        console.log(raw_items);
        if (e.innerHTML.length < 10) {
            raw_items.forEach((item) => {
                str += `<option>` + item.name + `</option>`;
            });
            e.innerHTML = str;
        }



    }
    function generate_purchase_order(e) {
        e.disabled = true;
        let ref = document.getElementById('lpo_ref').value;
        let po_num = document.getElementById('pur-po').innerHTML;
        let vendor = document.getElementById('pur-company-name').value;
        let date = document.getElementById("pur-date").value;
        let p_date = document.getElementById("payment_date").value;       
        let ship_info = {name: document.getElementById("pur-ship-name").value
            ,address:document.getElementById("pur-ship-address").value
            ,city:document.getElementById("pur-ship-city").value
            ,phone:document.getElementById("pur-ship-phone").value};
        let items_array = [];
        let table = document.getElementById('container');
        let tr = table.getElementsByTagName('tr');
        let item, description, quantity, price, obj;
        for (let i = 0; i < tr.length; i++) {
            item = tr[i].getElementsByTagName('td')[0].getElementsByTagName('select')[0].value;
            description = tr[i].getElementsByTagName('td')[1].getElementsByTagName('input')[0].value;
            quantity = parseFloat(tr[i].getElementsByTagName('td')[2].getElementsByTagName('input')[0].value);
            price = tr[i].getElementsByTagName('td')[3].getElementsByTagName('input')[0].value;

            obj = { item: item, description: description, quantity: quantity, price: price };
            items_array.push(obj);

        };
        items_array = JSON.stringify(items_array);
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                alert("Purchase Order is Generated");
                    e.disabled = false;
                   
                    var link = document.createElement("a");
                    link.download = 'purchase order.xlsx';
                     link.href = '/purchase_order_report';
                     link.click();
                     document.location.reload();

            }
        };
        xhttp.open("POST", "/purchase_order", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send("ref=" + ref + "&po_num=" + po_num  + "&date="+date+"&p_date="+p_date+"&purchase_array=" + items_array+"&ship_info="+JSON.stringify(ship_info)+"&vendor=" +vendor);

    }




</script>

</html>
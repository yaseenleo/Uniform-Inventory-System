<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Purchase Report</title>

    <link rel="stylesheet" href="../../../css/style.css">
    <link rel="stylesheet" href="../../../css/salesStyle.css">

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <!-- Font Awesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ"
        crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY"
        crossorigin="anonymous"></script>
    <style>
        .s_date, .e_date{
             display: none;
             max-width: 200px;

         }
        
        </style>
</head>

<body onload="fill()">

    <div class="nav-side-menu">
        <div class="brand brand-color">
            <h4>Uniform Inventory</h4>
        </div>
        <i class="fa fa-bars fa-2x toggle-btn" data-toggle="collapse" data-target="#menu-content"></i>
        <div class="menu-list" id="menu-content">

                <ul id="accordion1" class="menu-content collapse out">

                        <li data-toggle="collapse" data-parent="#accordion1" href="#thirdLink"> <a> <i></i> Sales</a>
        
                            <ul id="thirdLink" class="collapse sub-list">
                                <li>
                                    <a href="/sale/sales_order">Sales Order</a>
                                </li>
                                <li>
                                    <a href="/sale/packing_list">Packing List</a>
                                </li>
                                <li>
                                    <a href="/sale/commercial_invoice">Commercial Invoice</a>
                                </li>
                                <li>
                                    <a href="/sale/reciept_voucher">Reciept Voucher</a>
                                </li>
                            </ul>
                        </li>
                        <li data-toggle="collapse" data-parent="#accordion1" href="#firstLink"> <a> <i></i> Purchase</a>
        
                            <ul id="firstLink" class="collapse sub-list">
                                <li>
                                    <a href="/purchase/purchase_order">Purchase Order</a>
                                </li>
                                <li>
                                    <a href="/purchase/gr_note">Good Receiving Note / Invoice</a>
                                </li>
        
                                <li>
                                    <a href="/purchase/payment_voucher">Vendor Payment</a>
                                </li>
                            </ul>
        
                        </li>
                        <li>
                            <a href="/production">
                                <i></i> Production</a>
                        </li>
                        <li data-toggle="collapse" data-parent="#accordion1" href="#reports"> <a> <i></i> Reports</a>
        
                            <ul id="reports" class="collapse sub-list">
                                <li>
                                    <a href="/reports/sales_report">Sales Report</a>
                                </li>
                                <li>
                                    <a href="/reports/purchase_report">Purchases Report</a>
                                </li>
        
                                <li>
                                    <a href="/reports/production_report">Productions Report</a>
                                </li>
                                <li>
                                    <a href="/reports/accounts_report">Accounts Report</a>
                                </li>
                            </ul>
        
                        </li>
        
                        <li>
                            <a href="/master">
                                <i></i> Master Control
                            </a>
                        </li>
        
                        <li>
                            <a href="/master_view">
                                <i></i> Master View
        
                            </a>
                        </li>
        
                        <!-- <li>
                                <a href="/attendance">
                                    <i></i> Attendance
                                </a>
                            </li> -->
        
                    </ul>
        

        </div>
    </div>


    <div id="main" class="wrapper container-fluid">

        <div id="content" class="container-fluid">

            <h2 class="text-center">PURCHASE STATUS REPORTS</h2>
            <hr>
            <br>
            <div class="container">

                <div class="container">
                        <div class="row">
                                <div class="col-6">
                                    <button class='btn btn-primary' onclick="print(this)">Download Printable</button>
                                </div>
                            </div>
                    <!---  input search -->
                    <div class="row">
                        <div class="col-6">
                            <div class="input-group mb-3">

                                <div class="input-group-prepend s_date">
                                    <span class='input-group-text'>Start Date</span>
                                </div>
                                <input type='date' class='form-control s_date'>
                                <div class="input-group-prepend e_date">
                                    <span class='input-group-text'>End Date</span>
                                </div>
                                <input type='date' class='form-control e_date'>

                            </div>
                        </div>
                        <script>
                            function date_type(e) {
                                if (e.value === "any") {
                                    document.getElementsByClassName("s_date")[0].style.display = "none";
                                    document.getElementsByClassName("s_date")[1].style.display = "none";
                                    document.getElementsByClassName("e_date")[0].style.display = "none";
                                    document.getElementsByClassName("e_date")[1].style.display = "none";

                                }
                                else if (e.value === "start") {
                                    document.getElementsByClassName("s_date")[0].style.display = "block";
                                    document.getElementsByClassName("s_date")[1].style.display = "block";
                                    document.getElementsByClassName("e_date")[0].style.display = "none";
                                    document.getElementsByClassName("e_date")[1].style.display = "none";

                                }
                                else if (e.value === "end") {
                                    document.getElementsByClassName("s_date")[0].style.display = "none";
                                    document.getElementsByClassName("s_date")[1].style.display = "none";
                                    document.getElementsByClassName("e_date")[0].style.display = "block";
                                    document.getElementsByClassName("e_date")[1].style.display = "block";

                                }
                                else if (e.value === "range") {
                                    document.getElementsByClassName("s_date")[0].style.display = "block";
                                    document.getElementsByClassName("s_date")[1].style.display = "block";
                                    document.getElementsByClassName("e_date")[0].style.display = "block";
                                    document.getElementsByClassName("e_date")[1].style.display = "block";

                                }
                            }
                        </script>
                        <div class="col-6">
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class='input-group-text'>Date Range</span>
                                </div>
                                <select class='form-control' onChange="date_type(this)" style='max-width:200px' id='date_type'>
                                    <option value='any'>Any</option>
                                    <option value='start'>Starting from</option>
                                    <option value='end'>Upto</option>
                                    <option value='range'>Range</option>
                                </select>
                                <select class="form-control" id='vendors_select'>

                                </select>
                                <div class="input-group-prepend">
                                    <button class="input-group-text" onClick='select_vendor()'>Vendors Result</button>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!----- input search  -->
                    <table class="table table-light table-striped">
                        <thead>
                            <tr>
                                <th>V.P.O#</th>
                                <th>Vendor</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>

                            </tr>
                        </thead>
                        <tbody id='lpos_table'>

                        </tbody>
                    </table>
                    <table class='table table-dark'>
                            <tbody>
                                <tr>
                                    <td> total Purchase Orders: <span id='total_lpo'></span></td>
                                    <td>  &nbsp; </td>
                                    <td> &nbsp; </td>
                                    <td > &nbsp;</td>
                                    <td ><span style='float:right'>Total Amount: <span id='g_total'></span></span></td>
                                </tr>
                            </tbody>
                        </table>



                </div>
                <hr>





            </div>




        </div>


    </div>
    <!--- modal-->

    <!-- <p id="n"></p> -->
    <!-- <button onclick="waqaskhan();">Submit</button>
<input type="button" id="create_pdf" value="Generate PDF">  -->

</body>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>

<script src="../../../js/app.js"></script>

<script>
    var clients;
    function fill() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                vendors = JSON.parse(this.responseText).vendors;
                let txt = '<option value="all">All</option>';
                vendors.forEach((vendor) => {
                    txt += `<option value="` + vendor.company_name + `">` + vendor.company_name + `</option>`;
                });
                document.getElementById("vendors_select").innerHTML = txt;
            }
        };
        xhttp.open("GET", "/get_vendors", true);
        xhttp.send();
    }
    function load_lpos() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let pos = JSON.parse(this.responseText).pos;
                let table = document.getElementById('lpos_table');
                let str = '';
                pos.forEach((po) => {
                    str += '<tr><td>' + po.po_num + '</td><td>' + po.vendor + '</td><td>' + po.date + '</td><td>' + po.total + '</td><td>'+po.flag+'</td></tr>'
                });
                table.innerHTML = str;
                update();
            }
        };
        xhttp.open("GET", "/get_pos", true);
        xhttp.send();
    }
    function load_pos() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let pos = JSON.parse(this.responseText).pos;
                let table = document.getElementById('pos_table');
                let str = '';
                pos.forEach((po) => {
                    let str1 = `<table  style='font-size:12px;border:1px solid beige' class='items_list'><tbody>`;
                    let items = JSON.parse(po.purchase_array);
                    items.forEach((item) => {
                        str1 += `<tr><td>` + item.item + `</td><td>` + item.quantity + `</td><td>` + item.price + `(pkr)</td></tr>`;
                    });
                    str1 += `</tbody></table>`;
                    str += '<tr><td>' + po.po_num + '</td><td>' + po.ref + '</td><td>' + po.vendor + '</td><td>' + str1 + '</td><td>' + po.flag + '</td><td>' + po.date + '</td></tr>'
                });
                table.innerHTML = str;
            }
        };
        xhttp.open("GET", "/get_pos", true);
        xhttp.send();
    }
    function search(input, table) {

        var input, filter, found, table, tr, td, i, j;
        input = document.getElementById(input);
        filter = input.value.toUpperCase();
        table = document.getElementById(table);
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td");
            for (j = 0; j < td.length; j++) {
                if (td[j].innerHTML.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                }
            }
            if (found) {
                tr[i].style.display = "";
                found = false;
            } else {
                tr[i].style.display = "none";
            }
        }
    }
    load_lpos();
    load_pos();
</script>
<script>
    function select_vendor() {
        let s_date = document.getElementsByClassName('s_date')[1].value;
        let e_date = document.getElementsByClassName('e_date')[1].value;
        let date_type = document.getElementById("date_type").value;
        let client = document.getElementById("vendors_select").value;
        //table info //
        var found, table, tr, td, i, j;
        table = document.getElementById('lpos_table');
        tr = table.getElementsByTagName("tr");

        //table info //
        if (date_type === "any") {
            if (client === "all") {

                for (i = 0; i < tr.length; i++) {


                    tr[i].style.display = "";
                    console.log(i,tr[i].getElementsByTagName('td')[1].innerHTML);

                }
            }
            else {
                for (i = 0; i < tr.length; i++) {

                    if (tr[i].getElementsByTagName('td')[1].innerHTML === client) {
                        tr[i].style.display = "";

                    }
                    else {
                        tr[i].style.display = "none";

                    }

                }
            }
        }
        else {
            if (s_date === '' && e_date === '') {
                alert("please select the dates")
            }
            else {
                 if(client==="all")
                 {
                    for (i = 0; i < tr.length; i++) {
                        let lpo_date = tr[i].getElementsByTagName('td')[2].innerHTML;
                         found = date_check(lpo_date); 
                    if (found) {
                        tr[i].style.display = "";

                    }
                    else {
                        tr[i].style.display = "none";

                    }
                }
                 }
                 else{
                    for (i = 0; i < tr.length; i++) {
                        let lpo_date = tr[i].getElementsByTagName('td')[2].innerHTML;
                         found = date_check(lpo_date); 
                    if (found && tr[i].getElementsByTagName('td')[1].innerHTML === client) {
                        tr[i].style.display = "";

                    }
                    else {
                        tr[i].style.display = "none";

                    }
                }
                 }
               
            }
        }

        console.log(s_date);
        console.log(e_date);
        console.log(date_type);
        update();

        // alert("Ss")
    }
    function update(){
        let total_lpo=0,total=0;
        table = document.getElementById('lpos_table');
        tr = table.getElementsByTagName("tr");
        for(i=0; i < tr.length ; i++)
        {   
            if(tr[i].style.display!=='none')
            {
                total_lpo++;
                total += parseFloat(tr[i].getElementsByTagName('td')[3].innerHTML);
                console.log(tr[i]);

            }
        }
        document.getElementById('total_lpo').innerHTML = total_lpo;
        document.getElementById('g_total').innerHTML = total.toFixed(2);
    }
   
    function date_check(lpo_date){
        let date_type = document.getElementById('date_type').value
        let s_date = new Date(document.getElementsByClassName('s_date')[1].value).getTime();
        let e_date = new Date(document.getElementsByClassName('e_date')[1].value).getTime();
        let c_date = new Date(lpo_date).getTime();
        if((date_type === "any" )||
        (date_type === "start" && c_date >= s_date )||
        (date_type === "end" && c_date < e_date) ||
        (date_type === "range" && c_date < e_date && c_date >= s_date))
        {
            return true;
        }
        else{
            return false;
        }
    //    let date_type = document.getElementById("date_type").value;
    //    let s_d,s_m,s_y,l_d,l_m,l_y;
    //    s_d = s_date.split("-")[2];
    //    s_m = s_date.split("-")[1];
    //    s_y = s_date.split("-")[0];
    //    l_d = lpo_date.split("-")[2];
    //    l_m = lpo_date.split("-")[1];
    //    l_y = lpo_date.split("-")[0];
    //    var date = new Date(s_date); 
    //     c
    }
    function print(e){
        e.disabled = true;
        let table= document.getElementById('lpos_table');
        let tr = table.getElementsByTagName('tr');
        let total_lpo = document.getElementById('total_lpo').innerHTML,
        g_total = document.getElementById('g_total').innerHTML;
        let array =[];
        for(let i=0; i < tr.length ; i++){
            if(tr[i].style.display!=='none')
            {
                array.push([
               tr[i].getElementsByTagName('td')[0].innerHTML,
               tr[i].getElementsByTagName('td')[1].innerHTML,
               tr[i].getElementsByTagName('td')[2].innerHTML,
               tr[i].getElementsByTagName('td')[3].innerHTML,
               tr[i].getElementsByTagName('td')[4].innerHTML  
            ])
            }
           
        }
        array = JSON.stringify(array);
        console.log(array);
        console.log(total_lpo);
        console.log(g_total);
        var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    alert("Purchase Report is Generated");
                    e.disabled = false;
                    var link = document.createElement("a");
                    link.download = 'purchase report.xlsx';
                    link.href = '/purchase_report';
                    link.click();
                }
            };
            xhttp.open("POST", "/purchase_report", true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhttp.send("array="+array+"&total_lpo="+total_lpo+"&g_total="+g_total);


    }
    let s_date = '2019-1-1'; 
    var date = new Date(s_date).getTime(); 
        console.log(date);
</script>

</html>